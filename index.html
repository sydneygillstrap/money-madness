<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spring Money Madness</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <!-- Retro Font -->
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    
    <style>
        body {
            background-color: #86efac; /* Light Green Spring bg */
            font-family: 'Press Start 2P', cursive;
            color: #1f2937; /* Dark gray text for readability on light bg */
            image-rendering: pixelated;
            overflow: hidden; /* Prevent scrolling on key press */
        }
        .pixel-border {
            box-shadow: -4px 0 0 0 white, 4px 0 0 0 white, 0 -4px 0 0 white, 0 4px 0 0 white;
            margin: 4px;
        }
        .pixel-btn {
            box-shadow: inset -4px -4px 0px 0px rgba(0,0,0,0.2);
            transition: transform 0.1s;
        }
        .pixel-btn:active {
            box-shadow: inset 4px 4px 0px 0px rgba(0,0,0,0.2);
            transform: translateY(2px);
        }
        .coin-scroll::-webkit-scrollbar { height: 8px; }
        .coin-scroll::-webkit-scrollbar-track { background: #d1fae5; }
        .coin-scroll::-webkit-scrollbar-thumb { background: #059669; }
        
        .animate-shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        
        /* Maze Styles - BIGGER */
        .maze-cell { width: 50px; height: 50px; }
        .player-token { transition: all 0.2s linear; }

        /* Text Outline Utility */
        .text-outline {
            text-shadow: 
                -2px -2px 0 #000,  
                 2px -2px 0 #000,
                -2px  2px 0 #000,
                 2px  2px 0 #000;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;

        // --- Level Config (Themed by Character) ---
        const THEMED_LEVELS = {
            gnome: [
                { id: 1, name: "Toadstool Village", icon: "üçÑ", bg: "bg-red-200", wall: "bg-red-600", path: "bg-red-50" },
                { id: 2, name: "Root Cellar", icon: "ü•ï", bg: "bg-orange-200", wall: "bg-orange-600", path: "bg-orange-50" },
                { id: 3, name: "Mossy Rock", icon: "ü™®", bg: "bg-stone-300", wall: "bg-stone-600", path: "bg-stone-100" },
                { id: 4, name: "Gem Mine", icon: "üíé", bg: "bg-blue-200", wall: "bg-blue-600", path: "bg-blue-50" },
                { id: 5, name: "Tree Stump", icon: "ü™µ", bg: "bg-amber-300", wall: "bg-amber-700", path: "bg-amber-100" }
            ],
            frog: [
                { id: 1, name: "Quiet Pond", icon: "üíß", bg: "bg-blue-300", wall: "bg-blue-600", path: "bg-blue-100" },
                { id: 2, name: "Lily Pad Lane", icon: "üê∏", bg: "bg-green-400", wall: "bg-green-700", path: "bg-green-200" },
                { id: 3, name: "Misty Swamp", icon: "üå´Ô∏è", bg: "bg-slate-400", wall: "bg-slate-700", path: "bg-slate-200" },
                { id: 4, name: "Rushing River", icon: "üåä", bg: "bg-cyan-300", wall: "bg-cyan-600", path: "bg-cyan-100" },
                { id: 5, name: "Waterfall Cave", icon: "üåà", bg: "bg-indigo-400", wall: "bg-indigo-700", path: "bg-indigo-200" }
            ],
            fairy: [
                { id: 1, name: "Pixie Hollow", icon: "‚ú®", bg: "bg-yellow-100", wall: "bg-yellow-400", path: "bg-white" },
                { id: 2, name: "Flower Bud", icon: "üå∑", bg: "bg-pink-200", wall: "bg-pink-500", path: "bg-pink-50" },
                { id: 3, name: "Butterfly Wing", icon: "ü¶ã", bg: "bg-purple-200", wall: "bg-purple-500", path: "bg-purple-50" },
                { id: 4, name: "Moonlight Glade", icon: "üåô", bg: "bg-indigo-200", wall: "bg-indigo-600", path: "bg-indigo-50" },
                { id: 5, name: "Crystal Palace", icon: "üè∞", bg: "bg-cyan-100", wall: "bg-cyan-400", path: "bg-white" }
            ]
        };

        // --- Maze Layouts (10x10 Grid: 1=Wall, 0=Path, 2=Start) ---
        const MAZES = [
            // Level 1: Winding Path
            [
                [1,1,1,1,1,1,1,1,1,1],
                [1,2,0,0,0,0,0,1,0,1],
                [1,1,1,1,1,1,0,1,0,1],
                [1,0,0,0,0,0,0,1,0,1],
                [1,0,1,1,1,1,1,1,0,1],
                [1,0,0,0,0,0,0,0,0,1],
                [1,1,1,1,1,1,1,1,0,1],
                [1,0,0,0,0,0,0,0,0,1],
                [1,1,1,1,1,1,1,1,1,1]
            ],
            // Level 2: The Forked Road
            [
                [1,1,1,1,1,1,1,1,1,1],
                [1,2,0,1,0,0,0,0,0,1],
                [1,1,0,1,0,1,1,1,0,1],
                [1,0,0,0,0,0,0,1,0,1],
                [1,0,1,1,1,1,0,0,0,1],
                [1,0,0,0,0,1,1,1,0,1],
                [1,1,1,1,0,0,0,1,0,1],
                [1,0,0,0,0,1,0,0,0,1],
                [1,1,1,1,1,1,1,1,1,1]
            ],
            // Level 3: Blocks & Corners
            [
                [1,1,1,1,1,1,1,1,1,1],
                [1,2,0,0,0,1,0,0,0,1],
                [1,1,1,0,1,1,0,1,1,1],
                [1,0,0,0,0,0,0,0,0,1],
                [1,0,1,1,0,1,1,0,1,1],
                [1,0,1,0,0,0,1,0,0,1],
                [1,0,1,0,1,0,1,1,0,1],
                [1,0,0,0,1,0,0,0,0,1],
                [1,1,1,1,1,1,1,1,1,1]
            ],
            // Level 4: Tight Corridors
            [
                [1,1,1,1,1,1,1,1,1,1],
                [1,2,0,1,0,0,0,1,0,1],
                [1,1,0,1,0,1,0,1,0,1],
                [1,0,0,0,0,1,0,0,0,1],
                [1,0,1,1,1,1,1,1,0,1],
                [1,0,0,0,1,0,0,0,0,1],
                [1,1,1,0,1,0,1,1,1,1],
                [1,0,0,0,0,0,0,0,0,1],
                [1,1,1,1,1,1,1,1,1,1]
            ],
            // Level 5: The Spiral Trap
            [
                [1,1,1,1,1,1,1,1,1,1],
                [1,2,0,0,0,0,0,0,0,1],
                [1,0,1,1,1,1,1,1,0,1],
                [1,0,1,0,0,0,0,1,0,1],
                [1,0,1,0,1,1,0,1,0,1],
                [1,0,1,0,0,1,0,1,0,1],
                [1,0,1,1,0,1,0,1,0,1],
                [1,0,0,0,0,0,0,0,0,1],
                [1,1,1,1,1,1,1,1,1,1]
            ]
        ];

        // --- Game Data (Spring Themed) ---
        const questionsData = [
            // Level 1
            { id: 1, text: "The Easter Bunny dropped 2 quarters! How much money is that?", visualType: "coins", coins: ["quarter", "quarter"], options: ["25¬¢", "50¬¢", "$1.00"], correct: "50¬¢", hint: "25 + 25 = 50", enemy: "üê∞" },
            { id: 2, text: "You have 50¬¢. You buy a flower seed for 10¬¢. How much is left?", visualType: "subtraction", start: "50¬¢", minus: "10¬¢", options: ["60¬¢", "40¬¢", "30¬¢"], correct: "40¬¢", hint: "50 - 10", enemy: "üå±" },
            { id: 3, text: "The Busy Bee needs nectar! Add these up: 2 Dimes and 1 Nickel.", visualType: "coins", coins: ["dime", "dime", "nickel"], options: ["25¬¢", "30¬¢", "15¬¢"], correct: "25¬¢", hint: "10 + 10 + 5", enemy: "üêù" },
            // Level 2
            { id: 4, text: "You have $1.00. A playful squirrel takes 60¬¢! How much is left?", visualType: "simple", image: "üêøÔ∏è", options: ["40¬¢", "50¬¢", "60¬¢"], correct: "40¬¢", hint: "100 - 60", enemy: "üêøÔ∏è" },
            { id: 5, text: "The Garden Gate fee is 20¬¢. Which coins pay the fee?", visualType: "text-only", options: ["2 Dimes", "2 Nickels", "1 Quarter"], correct: "2 Dimes", hint: "10 + 10", enemy: "üö™" },
            { id: 6, text: "Picnic Sale! Lemonade (30¬¢) and a Cookie (20¬¢). Total cost?", visualType: "items", items: ["üçã 30¬¢", "üç™ 20¬¢"], options: ["10¬¢", "40¬¢", "50¬¢"], correct: "50¬¢", hint: "30 + 20", enemy: "üç™" },
            // Level 3
            { id: 7, text: "Found in the grass! 3 pennies and 1 nickel. Count it up.", visualType: "coins", coins: ["penny", "penny", "penny", "nickel"], options: ["8¬¢", "4¬¢", "13¬¢"], correct: "8¬¢", hint: "1+1+1+5", enemy: "üß∫" },
            { id: 8, text: "True or False: 100 pennies is the same amount as $1.00.", visualType: "simple", image: "üí∞", options: ["True", "False"], correct: "True", hint: "Yes!", enemy: "‚öñÔ∏è" },
            { id: 9, text: "You have 75¬¢. You spend 25¬¢ on a kite. What is left?", visualType: "subtraction", start: "75¬¢", minus: "25¬¢", options: ["100¬¢", "50¬¢", "25¬¢"], correct: "50¬¢", hint: "75 - 25", enemy: "ü™Å" },
            // Level 4
            { id: 10, text: "Which is the correct way to write fifty cents?", visualType: "text-only", options: ["$0.50", "0.50¬¢", "$50"], correct: "$0.50", hint: "$ in front", enemy: "‚úçÔ∏è" },
            { id: 11, text: "Finish the pattern counting by 10s: 10, 20, 30... what is next?", visualType: "simple", image: "ü¶ã", options: ["35", "40", "50"], correct: "40", hint: "+10", enemy: "üî¢" },
            { id: 12, text: "Garden Quest: Gloves are 15¬¢ and a spade is 5¬¢. Total cost?", visualType: "items", items: ["üß§ 15¬¢", "ü•Ñ 5¬¢"], options: ["20¬¢", "10¬¢", "25¬¢"], correct: "20¬¢", hint: "15 + 5", enemy: "üß§" },
            // Level 5
            { id: 13, text: "How many quarters do you need to make exactly $1.00?", visualType: "coins", coins: ["quarter", "quarter", "quarter", "quarter"], options: ["2", "3", "4"], correct: "4", hint: "4 quarters", enemy: "ü™ô" },
            { id: 14, text: "You had 90¬¢, but you lost a dime. How much do you have now?", visualType: "subtraction", start: "90¬¢", minus: "10¬¢", options: ["80¬¢", "100¬¢", "85¬¢"], correct: "80¬¢", hint: "90 - 10", enemy: "üìâ" },
            { id: 15, text: "Big Blossom Challenge! Do 2 quarters and 5 dimes equal $1.00?", visualType: "coins", coins: ["quarter", "quarter", "dime", "dime", "dime", "dime", "dime"], options: ["Yes", "No"], correct: "Yes", hint: "50 + 50", enemy: "üåª" }
        ];

        const Coin = ({ type, onClick, small }) => {
            const sizeClass = small ? (type === 'quarter' ? 'w-10 h-10' : 'w-8 h-8') : (type === 'quarter' ? 'w-16 h-16' : type === 'dime' ? 'w-12 h-12' : 'w-14 h-14');
            const styles = {
                penny: "bg-orange-700 border-orange-900 text-orange-100",
                nickel: "bg-gray-400 border-gray-600 text-white",
                dime: "bg-gray-300 border-gray-500 text-gray-800",
                quarter: "bg-gray-200 border-gray-500 text-gray-900"
            };
            const labels = { penny: "1¬¢", nickel: "5¬¢", dime: "10¬¢", quarter: "25¬¢" };
            return (
                <div onClick={onClick} className={`${styles[type]} ${sizeClass} rounded-full border-4 flex items-center justify-center font-bold m-1 transform hover:scale-110 active:scale-90 transition-all cursor-pointer select-none shadow-lg text-[10px] md:text-sm`}>
                    {labels[type]}
                </div>
            );
        };

        const CoinWorkspace = () => {
            const [workspaceCoins, setWorkspaceCoins] = useState([]);
            const addCoin = (type) => setWorkspaceCoins([...workspaceCoins, { type, id: Date.now() }]);
            const removeCoin = (id) => setWorkspaceCoins(workspaceCoins.filter(c => c.id !== id));
            const clearAll = () => setWorkspaceCoins([]);
            return (
                <div className="bg-white border-4 border-green-600 p-4 w-full h-full rounded-lg shadow-xl">
                    <div className="flex justify-between items-center mb-2 border-b-2 border-green-200 pb-2">
                        <h3 className="text-green-700 text-sm md:text-base uppercase tracking-widest font-bold">üéí Backpack</h3>
                        <button onClick={clearAll} className="text-xs bg-red-500 text-white px-3 py-2 rounded hover:bg-red-400 pixel-btn">RESET</button>
                    </div>
                    <div className="flex justify-center gap-2 mb-4 bg-green-50 p-2 rounded border-2 border-green-200">
                        <Coin type="penny" small onClick={() => addCoin('penny')} />
                        <Coin type="nickel" small onClick={() => addCoin('nickel')} />
                        <Coin type="dime" small onClick={() => addCoin('dime')} />
                        <Coin type="quarter" small onClick={() => addCoin('quarter')} />
                    </div>
                    <div className="min-h-[200px] bg-green-50 rounded border-2 border-dashed border-green-300 p-2 flex flex-wrap content-start items-start coin-scroll">
                        {workspaceCoins.length === 0 && <span className="w-full text-center text-green-700 text-xs mt-8">Items go here...</span>}
                        {workspaceCoins.map((c) => <Coin key={c.id} type={c.type} small onClick={() => removeCoin(c.id)} />)}
                    </div>
                </div>
            );
        };

        const MoneyMadness = () => {
            const [gameState, setGameState] = useState('start'); 
            const [character, setCharacter] = useState(null);
            const [currentLevelSet, setCurrentLevelSet] = useState(THEMED_LEVELS.gnome);
            
            // Level State
            const [currentLevelIdx, setCurrentLevelIdx] = useState(0);
            const [levelTasks, setLevelTasks] = useState([]);
            const [grid, setGrid] = useState([]);
            const [playerPos, setPlayerPos] = useState({ x: 1, y: 1 });
            const [activeTaskIndex, setActiveTaskIndex] = useState(null);
            
            // Global State
            const [gold, setGold] = useState(0);
            const [attempts, setAttempts] = useState(0); 
            const [disabledOptions, setDisabledOptions] = useState([]);
            const [shake, setShake] = useState(false);
            const [completedTasks, setCompletedTasks] = useState(0);

            const characters = [
                { id: 'gnome', name: 'Gnome', icon: 'üéÖ', color: 'bg-red-500' },
                { id: 'fairy', name: 'Fairy', icon: 'üßö', color: 'bg-pink-400' },
                { id: 'frog', name: 'Froggy', icon: 'üê∏', color: 'bg-green-500' }
            ];

            const currentLevelData = currentLevelSet[currentLevelIdx] || currentLevelSet[0];

            // --- Movement Logic ---
            const handleMove = useCallback((dx, dy) => {
                if (gameState !== 'maze') return;
                
                const newX = playerPos.x + dx;
                const newY = playerPos.y + dy;

                if (newY < 0 || newY >= grid.length || newX < 0 || newX >= grid[0].length) return;
                if (grid[newY][newX] === 1) return;

                setPlayerPos({ x: newX, y: newY });

                const taskIndex = levelTasks.findIndex(t => t.x === newX && t.y === newY && t.status === 'open');
                if (taskIndex !== -1) {
                    setActiveTaskIndex(taskIndex);
                    setAttempts(0);
                    setDisabledOptions([]);
                    setGameState('playing');
                }
            }, [gameState, grid, playerPos, levelTasks]);

            // Keyboard Listeners
            useEffect(() => {
                const handleKeyDown = (e) => {
                    if (e.key === 'ArrowUp') handleMove(0, -1);
                    if (e.key === 'ArrowDown') handleMove(0, 1);
                    if (e.key === 'ArrowLeft') handleMove(-1, 0);
                    if (e.key === 'ArrowRight') handleMove(1, 0);
                };
                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, [handleMove]);


            const startGame = (char) => {
                setCharacter(char);
                setCurrentLevelSet(THEMED_LEVELS[char.id]);
                setCurrentLevelIdx(0);
                setGold(0);
                startLevel(0, THEMED_LEVELS[char.id]);
            };

            const startLevel = (lvlIdx, levelSet = currentLevelSet) => {
                const startQ = lvlIdx * 3;
                const endQ = startQ + 3;
                
                const baseMaze = MAZES[lvlIdx] || MAZES[0];
                const newGrid = baseMaze.map(row => [...row]); 

                let startX = 1, startY = 1;
                for(let y=0; y<newGrid.length; y++) {
                    for(let x=0; x<newGrid[0].length; x++) {
                        if(newGrid[y][x] === 2) {
                            startX = x;
                            startY = y;
                        }
                    }
                }
                
                const tasksForLevel = questionsData.slice(startQ, endQ).map((q, i) => {
                    let placed = false;
                    let tx = 0, ty = 0;
                    while (!placed) {
                        const ry = Math.floor(Math.random() * newGrid.length);
                        const rx = Math.floor(Math.random() * newGrid[0].length);
                        if (newGrid[ry][rx] === 0 && (Math.abs(rx-startX) > 1 || Math.abs(ry-startY) > 1)) {
                            tx = rx; ty = ry;
                            placed = true;
                            newGrid[ry][rx] = 9; 
                        }
                    }
                    return { ...q, x: tx, y: ty, status: 'open' };
                });

                setGrid(baseMaze); 
                setPlayerPos({ x: startX, y: startY });
                setLevelTasks(tasksForLevel);
                setCompletedTasks(0);
                setCurrentLevelIdx(lvlIdx);
                setGameState('levelIntro');
            };

            const enterMap = () => {
                setGameState('maze');
            };

            const handleAnswer = (option) => {
                const currentTask = levelTasks[activeTaskIndex];
                if (option === currentTask.correct) {
                    setGold(g => g + (attempts === 0 ? 100 : 50));
                    confetti({ particleCount: 50, spread: 60, origin: { y: 0.7 } });
                    
                    const newTasks = [...levelTasks];
                    newTasks[activeTaskIndex].status = 'solved';
                    setLevelTasks(newTasks);
                    setCompletedTasks(prev => prev + 1);

                    setTimeout(() => {
                        const allSolved = newTasks.every(t => t.status === 'solved');
                        if (allSolved) {
                             if (currentLevelIdx === 4) setGameState('end');
                             else setGameState('levelOutro');
                        } else {
                            setGameState('maze');
                        }
                    }, 1000);

                } else {
                    if (attempts === 0) {
                        setAttempts(1);
                        setDisabledOptions(prev => [...prev, option]);
                        setShake(true);
                        setTimeout(() => setShake(false), 500);
                    } else {
                        setShake(true);
                        setTimeout(() => setShake(false), 500);
                        const newTasks = [...levelTasks];
                        newTasks[activeTaskIndex].status = 'solved';
                        setLevelTasks(newTasks);
                        setCompletedTasks(prev => prev + 1);
                        
                        setTimeout(() => {
                            const allSolved = newTasks.every(t => t.status === 'solved');
                            if (allSolved) {
                                if (currentLevelIdx === 4) setGameState('end');
                                else setGameState('levelOutro');
                            } else {
                                setGameState('maze');
                            }
                        }, 1000);
                    }
                }
            };
            
            const advanceLevel = () => {
                 startLevel(currentLevelIdx + 1);
            };

            // --- RENDERERS ---

            if (gameState === 'start') {
                return (
                    <div className="flex flex-col items-center justify-center min-h-screen p-4 text-center">
                        <h1 className="text-3xl md:text-5xl text-pink-600 mb-8 drop-shadow-md font-bold text-outline text-white">SPRING MONEY MADNESS</h1>
                        <p className="text-gray-800 mb-8 text-sm md:text-base max-w-md font-bold">Pick your character to explore the Spring Garden!</p>
                        <div className="flex gap-4 flex-wrap justify-center">
                            {characters.map(c => (
                                <button key={c.id} onClick={() => startGame(c)} className={`flex flex-col items-center justify-center w-36 h-48 ${c.color} border-4 border-white pixel-btn hover:scale-105 transition-transform rounded-xl`}>
                                    <span className="text-5xl mb-4">{c.icon}</span>
                                    <span className="text-sm uppercase text-white font-bold text-outline">{c.name}</span>
                                </button>
                            ))}
                        </div>
                    </div>
                );
            }

            if (gameState === 'levelIntro') {
                return (
                     <div className={`flex flex-col items-center justify-center min-h-screen p-4 text-center ${currentLevelData.bg} transition-colors duration-1000`}>
                        <h2 className="text-white text-xl mb-4 opacity-90 font-bold text-outline">ENTERING LEVEL {currentLevelIdx + 1}</h2>
                        <h1 className="text-4xl md:text-6xl text-white mb-8 drop-shadow-md font-bold text-outline">{currentLevelData.name}</h1>
                        <div className="text-9xl mb-8 animate-bounce">{currentLevelData.icon}</div>
                        <p className="text-white text-sm mb-8 font-bold text-outline">Navigate the world to find 3 surprises!</p>
                        <button onClick={enterMap} className="bg-white text-green-700 border-4 border-green-600 px-8 py-4 pixel-btn text-lg uppercase rounded-full font-bold shadow-lg">
                            ENTER MAZE
                        </button>
                    </div>
                );
            }

            if (gameState === 'maze') {
                return (
                    <div className={`min-h-screen flex flex-col items-center py-2 px-2 ${currentLevelData.bg}`}>
                        {/* HUD */}
                        <div className="w-full max-w-lg mb-2 flex justify-between items-center bg-white bg-opacity-95 p-3 border-4 border-green-600 rounded-xl shadow-lg">
                            <div className="text-left">
                                <div className="text-xs text-gray-500 font-bold">LEVEL {currentLevelIdx + 1}</div>
                                <div className="text-sm text-green-700 font-black">{currentLevelData.name}</div>
                            </div>
                            <div className="text-right">
                                <div className="text-xs text-gray-500 font-bold">TASKS</div>
                                <div className="flex gap-2">
                                    {[0,1,2].map(i => (
                                        <span key={i} className={`text-xl ${i < completedTasks ? 'text-green-500' : 'text-gray-300'}`}>
                                            {i < completedTasks ? 'üå∏' : '‚ö™'}
                                        </span>
                                    ))}
                                </div>
                            </div>
                        </div>
                        
                        {/* MAZE GRID (BIGGER) */}
                        <div className="relative bg-white border-4 border-white p-2 rounded-xl shadow-2xl overflow-auto max-w-full">
                            {grid.map((row, rowIndex) => (
                                <div key={rowIndex} className="flex">
                                    {row.map((cell, colIndex) => {
                                        const isWall = cell === 1;
                                        const task = levelTasks.find(t => t.x === colIndex && t.y === rowIndex && t.status === 'open');
                                        const isPlayer = playerPos.x === colIndex && playerPos.y === rowIndex;
                                        
                                        return (
                                            <div 
                                                key={colIndex} 
                                                className={`maze-cell flex-shrink-0 flex items-center justify-center rounded-md m-[1px] ${isWall ? currentLevelData.wall : currentLevelData.path}`}
                                            >
                                                {task && <span className="text-4xl animate-pulse drop-shadow-md">{task.enemy}</span>}
                                                {isPlayer && <span className="text-4xl z-10 drop-shadow-md">{character.icon}</span>}
                                            </div>
                                        );
                                    })}
                                </div>
                            ))}
                        </div>

                        {/* CONTROLS (D-PAD) */}
                        <div className="mt-4 grid grid-cols-3 gap-2 scale-110">
                            <div></div>
                            <button onTouchStart={() => handleMove(0, -1)} onClick={() => handleMove(0, -1)} className="w-16 h-16 bg-white border-b-4 border-gray-300 rounded-full flex items-center justify-center text-3xl active:bg-gray-200 shadow-md">‚¨ÜÔ∏è</button>
                            <div></div>
                            <button onTouchStart={() => handleMove(-1, 0)} onClick={() => handleMove(-1, 0)} className="w-16 h-16 bg-white border-b-4 border-gray-300 rounded-full flex items-center justify-center text-3xl active:bg-gray-200 shadow-md">‚¨ÖÔ∏è</button>
                            <button onTouchStart={() => handleMove(0, 1)} onClick={() => handleMove(0, 1)} className="w-16 h-16 bg-white border-b-4 border-gray-300 rounded-full flex items-center justify-center text-3xl active:bg-gray-200 shadow-md">‚¨áÔ∏è</button>
                            <button onTouchStart={() => handleMove(1, 0)} onClick={() => handleMove(1, 0)} className="w-16 h-16 bg-white border-b-4 border-gray-300 rounded-full flex items-center justify-center text-3xl active:bg-gray-200 shadow-md">‚û°Ô∏è</button>
                        </div>
                        <div className="text-xs text-gray-800 mt-4 font-bold bg-white bg-opacity-70 px-3 py-1 rounded-full shadow">Use Arrow Keys or Buttons</div>
                    </div>
                );
            }

            if (gameState === 'playing') {
                const currentTask = levelTasks[activeTaskIndex];
                
                return (
                    <div className={`min-h-screen flex flex-col items-center py-4 px-4 max-w-6xl mx-auto ${shake ? 'animate-shake' : ''}`}>
                         {/* Header */}
                         <div className="w-full flex justify-between items-center mb-6 bg-white p-4 border-4 border-green-500 rounded-xl shadow-lg">
                            <div className="flex items-center gap-4">
                                <div className={`w-14 h-14 flex items-center justify-center text-3xl ${character.color} border-2 border-white rounded-full shadow`}>{character.icon}</div>
                                <div className="flex flex-col text-left"><span className="text-xs text-gray-500 font-bold">PLAYER</span><span className="text-sm text-green-700 font-black">{character.name}</span></div>
                            </div>
                            <div className="flex flex-col text-right"><span className="text-xs text-yellow-600 font-bold">GOLD</span><span className="text-2xl text-yellow-500 font-black text-outline">{gold}</span></div>
                        </div>

                        <div className="flex flex-col md:flex-row gap-6 w-full items-start h-full">
                            <div className="flex-1 w-full bg-white border-4 border-green-500 rounded-xl shadow-xl relative overflow-hidden">
                                <div className="absolute top-3 right-3 flex gap-1"><span className="text-red-500 text-xl">{attempts === 0 ? '‚ù§Ô∏è‚ù§Ô∏è' : attempts === 1 ? '‚ù§Ô∏èüñ§' : 'üñ§üñ§'}</span></div>
                                <div className={`p-8 border-b-4 border-green-200 ${currentLevelData.bg} text-center min-h-[140px] flex items-center justify-center`}>
                                    <h2 className="text-sm md:text-lg leading-relaxed text-gray-900 font-bold bg-white bg-opacity-90 p-4 rounded-xl shadow-sm border-2 border-white">{currentTask.text}</h2>
                                </div>

                                <div className="p-8 flex flex-col items-center justify-center min-h-[220px] bg-green-50 relative">
                                    {currentTask.visualType === 'coins' && <div className="flex flex-wrap justify-center gap-4">{currentTask.coins.map((c, i) => <Coin key={i} type={c} />)}</div>}
                                    {currentTask.visualType === 'subtraction' && (<div className="flex items-center text-2xl md:text-4xl font-black text-gray-700 gap-4"><div className="bg-white px-6 py-3 border-4 border-gray-300 rounded-xl shadow-sm">{currentTask.start}</div><div className="text-red-500">-</div><div className="bg-white px-6 py-3 border-4 border-gray-300 rounded-xl shadow-sm">{currentTask.minus}</div></div>)}
                                    {currentTask.visualType === 'items' && <div className="flex gap-6 md:gap-10 text-4xl md:text-5xl">{currentTask.items.map((item, i) => <div key={i} className="flex flex-col items-center"><span>{item.split(' ')[0]}</span><span className="text-sm bg-gray-800 text-white px-3 py-1 rounded-full mt-2 border-2 border-gray-500 font-bold">{item.split(' ')[1]}</span></div>)}</div>}
                                    {currentTask.visualType === 'simple' && <div className="text-7xl animate-bounce">{currentTask.image}</div>}
                                    {currentTask.visualType === 'text-only' && <div className="text-8xl text-gray-300 font-black">?</div>}
                                    
                                    {attempts === 1 && <div className="absolute bottom-4 left-0 right-0 text-center bg-yellow-100 text-yellow-800 py-2 text-sm border-y-4 border-yellow-300 animate-pulse font-bold">HINT: {currentTask.hint}</div>}
                                </div>

                                <div className="p-6 bg-gray-50 grid grid-cols-1 md:grid-cols-3 gap-4">
                                    {currentTask.options.map((opt, i) => (
                                        <button key={i} onClick={() => !disabledOptions.includes(opt) && handleAnswer(opt)} className={`py-6 border-b-8 rounded-xl text-sm md:text-lg pixel-btn transition-colors font-black ${disabledOptions.includes(opt) ? 'bg-gray-200 text-gray-400 border-gray-300' : 'bg-blue-100 text-blue-900 border-blue-300 hover:bg-blue-200'}`} disabled={disabledOptions.includes(opt)}>
                                            {opt}
                                        </button>
                                    ))}
                                </div>
                            </div>
                            <div className="w-full md:w-80 flex-shrink-0"><CoinWorkspace /></div>
                        </div>
                    </div>
                );
            }

            if (gameState === 'levelOutro') {
                 return (
                     <div className={`flex flex-col items-center justify-center min-h-screen p-4 text-center bg-white`}>
                        <h1 className="text-5xl text-green-500 mb-6 font-bold text-outline text-white drop-shadow-md">LEVEL COMPLETE!</h1>
                        <p className="text-gray-600 mb-8 text-lg font-bold">You cleared the area!</p>
                        <button onClick={advanceLevel} className="bg-blue-500 text-white border-4 border-blue-700 px-10 py-5 pixel-btn text-lg uppercase rounded-full font-bold shadow-xl">NEXT LEVEL ‚û°</button>
                    </div>
                );
            }

            if (gameState === 'end') {
                return (
                    <div className="flex flex-col items-center justify-center min-h-screen p-4 text-center bg-green-50">
                        <h1 className="text-5xl md:text-7xl mb-8 text-green-500 font-bold text-outline text-white drop-shadow-xl">Spring Champion!</h1>
                        <div className="bg-white p-10 border-8 border-green-400 mb-10 rounded-2xl shadow-2xl">
                            <p className="text-yellow-500 text-2xl mb-4 font-bold uppercase tracking-widest">Total Gold</p>
                            <p className="text-gray-800 text-6xl font-black">{gold}</p>
                        </div>
                        <button onClick={() => setGameState('start')} className="bg-green-500 text-white border-4 border-green-700 px-12 py-6 pixel-btn rounded-full font-bold text-xl shadow-lg hover:scale-105 transition-transform">PLAY AGAIN</button>
                    </div>
                );
            }
            return null;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<MoneyMadness />);
    </script>
</body>
</html>
